/*-
 * Copyright (c) 2016 Robert N. M. Watson
 * All rights reserved.
 *
 * This software was developed by SRI International and the University of
 * Cambridge Computer Laboratory under DARPA/AFRL contract (FA8750-10-C-0237)
 * ("CTSRD"), as part of the DARPA CRASH research programme.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */

#include <sys/cdefs.h>
__FBSDID("$FreeBSD$");

#include <sys/param.h>

#include <machine/cpuregs.h>

#include <mips.h>

static void *__mips_ckseg_cached__;

static uint64_t beri_l1_icache_size, beri_l1_icache_linesize;
static uint64_t beri_l1_dcache_size, beri_l1_dcache_linesize;

/*
 * Issue pipeline sync instruction; ensure it is not reordered relative to
 * other instructions generated by the compiler/assembler.
 */
static __inline void
beri_sync(void)
{

	__asm__ __volatile__ (".set push\n"
			    ".set noreorder\n"
			    ".set mips64\n"
			    "\tsync\n"
			    ".set pop\n");
}

void
beri_cache_configure(void)
{
	uint32_t cfg, tmp;

	cfg = cp0_config_get();

	/*
	 * Extract L1 instruction-cache parameters from the config register.
	 */
	beri_l1_icache_linesize = MIPS_CONFIG_CACHE_L1_LSIZE(cfg,
	    MIPS_CONFIG_IB);
	tmp = (cfg & MIPS_CONFIG_IC_MASK) >> MIPS_CONFIG_IC_SHIFT;
	beri_l1_icache_size = 2 << (MIPS_CONFIG_C_DEFBASE + tmp);

	/*
	 * Extract L1 data-cache parameters.
	 */
	beri_l1_dcache_linesize = MIPS_CONFIG_CACHE_L1_LSIZE(cfg,
	    MIPS_CONFIG_DB);
	tmp = (cfg & MIPS_CONFIG_DC_MASK) >> MIPS_CONFIG_DC_SHIFT;
	beri_l1_dcache_size = 2 << (MIPS_CONFIG_C_DEFBASE + tmp);
}

static void
beri_dcache_writeback_invalidate_line(uint64_t va)
{

	__asm__ __volatile__ (".set push\n"
			    ".set noreorder\n"
			    ".set mips64\n"
			    "\tcache 1, 0(%0)\n"
			    ".set pop\n" : : "r" (va) : "memory");
}

static void
beri_icache_invalidate_line(uint64_t va)
{

	__asm__ __volatile__ (".set push\n"
			    ".set noreorder\n"
			    ".set mips64\n"
			    "\tcache 0, 0(%0)\n"
			    ".set pop\n" : : "r" (va) : "memory");
}

/*
 * After loading an ELF file, use this function to ensure any changes to
 * memory are visible in the instruction cache.
 */
void
beri_icache_sync(void)
{
	uint64_t eva, va;

	/*
	 * First write back the L1 data cache to force any code we've written
	 * back into the L2.
	 */
	va = (uint64_t)&__mips_ckseg_cached__;
	eva = va + beri_l1_dcache_size;
	while (va < eva) {
		beri_dcache_writeback_invalidate_line(va);
		va += beri_l1_dcache_linesize;
	}

	/*
	 * Next, invalidate the L1 instruction cache.
	 */
	va = (uint64_t)&__mips_ckseg_cached__;
	eva = va + beri_l1_icache_size;
	while  (va < eva) {
		beri_icache_invalidate_line(va);
		va += beri_l1_icache_linesize;
	}
	beri_sync();
}
